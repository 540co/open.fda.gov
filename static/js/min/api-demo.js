function stringToTitleCase(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function numberToCommaSeparated(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function replaceCountryCode(e){var t={"":"No data","*":"No answer provided",AA:"Aruba",AC:"Antigua and Barbuda",AE:"United Arab Emirates",AF:"Afghanistan",AG:"Algeria",AJ:"Azerbaijan",AL:"Albania",AM:"Armenia",AN:"Andorra",AO:"Angola",AQ:"American Samoa",AR:"Argentina",AS:"Australia",AT:"Ashmore and Cartier Islands",AU:"Austria",AV:"Anguilla",AX:"Akrotiri",AY:"Antarctica",BA:"Bahrain",BB:"Barbados",BC:"Botswana",BD:"Bermuda",BE:"Belgium",BF:"Bahamas, The",BG:"Bangladesh",BH:"Belize",BK:"Bosnia and Herzegovina",BL:"Bolivia",BM:"Burma",BN:"Benin",BO:"Belarus",BP:"Solomon Islands",BQ:"Navassa Island",BR:"Brazil",BS:"French Southern and Antarctic Lands Bassas da India",BT:"Bhutan",BU:"Bulgaria",BV:"Bouvet Island",BX:"Brunei",BY:"Burundi",CA:"Canada",CB:"Cambodia",CD:"Chad",CE:"Sri Lanka",CF:"Congo (Brazzaville)",CG:"Congo (Kinshasa)",CH:"China",CI:"Chile",CJ:"Cayman Islands",CK:"Cocos (Keeling) Islands",CM:"Cameroon",CN:"Comoros",CO:"Colombia",CQ:"Northern Mariana Islands",CR:"Coral Sea Islands",CS:"Costa Rica",CT:"Central African Republic",CU:"Cuba",CV:"Cape Verde",CW:"Cook Islands",CY:"Cyprus",DA:"Denmark",DJ:"Djibouti",DO:"Dominica",DQ:"Jarvis Island",DR:"Dominican Republic",DX:"Dhekelia",EC:"Ecuador",EG:"Egypt",EI:"Ireland",EK:"Equatorial Guinea",EN:"Estonia",ER:"Eritrea",ES:"El Salvador",ET:"Ethiopia",EU:"French Southern and Antarctic Lands Europa Island",EZ:"Czech Republic",FG:"French Guiana",FI:"Finland",FJ:"Fiji",FK:"Falkland Islands (Islas Malvinas)",FM:"Micronesia, Federated States of",FO:"Faroe Islands",FP:"French Polynesia",FQ:"Baker Island",FR:"France",FS:"French Southern and Antarctic Lands",GA:"Gambia, The",GB:"Gabon",GG:"Georgia",GH:"Ghana",GI:"Gibraltar",GJ:"Grenada",GK:"Guernsey",GL:"Greenland",GM:"Germany",GO:"French Southern and Antarctic Lands Glorioso Islands",GP:"Guadeloupe",GQ:"Guam",GR:"Greece",GT:"Guatemala",GV:"Guinea",GY:"Guyana",GZ:"Gaza Strip",HA:"Haiti",HK:"Hong Kong",HM:"Heard Island and McDonald Islands",HO:"Honduras",HQ:"Howland Island",HR:"Croatia",HU:"Hungary",IC:"Iceland",ID:"Indonesia",IM:"Isle of Man",IN:"India",IO:"British Indian Ocean Territory",IP:"Clipperton Island",IR:"Iran",IS:"Israel",IT:"Italy",IV:"Côte d'Ivoire",IZ:"Iraq",JA:"Japan",JE:"Jersey",JM:"Jamaica",JN:"Jan Mayen",JO:"Jordan",JQ:"Johnston Atoll",JU:"French Southern and Antarctic Lands Juan de Nova Island",KE:"Kenya",KG:"Kyrgyzstan",KN:"Korea, North",KQ:"Kingman Reef",KR:"Kiribati",KS:"Korea, South",KT:"Christmas Island",KU:"Kuwait",KV:"Kosovo",KZ:"Kazakhstan",LA:"Laos",LE:"Lebanon",LG:"Latvia",LH:"Lithuania",LI:"Liberia",LO:"Slovakia",LQ:"Palmyra Atoll",LS:"Liechtenstein",LT:"Lesotho",LU:"Luxembourg",LY:"Libya",MA:"Madagascar",MB:"Martinique",MC:"Macau",MD:"Moldova",MF:"Mayotte",MG:"Mongolia",MH:"Montserrat",MI:"Malawi",MJ:"Montenegro",MK:"Macedonia",ML:"Mali",MN:"Monaco",MO:"Morocco",MP:"Mauritius",MQ:"Midway Islands",MR:"Mauritania",MT:"Malta",MU:"Oman",MV:"Maldives",MX:"Mexico",MY:"Malaysia",MZ:"Mozambique",NC:"New Caledonia",NE:"Niue",NF:"Norfolk Island",NG:"Niger",NH:"Vanuatu",NI:"Nigeria",NL:"Netherlands",NN:"Sint Maarten",NO:"Norway",NP:"Nepal",NR:"Nauru",NS:"Suriname",NU:"Nicaragua",NZ:"New Zealand",OD:"South Sudan",PA:"Paraguay",PC:"Pitcairn Islands",PE:"Peru",PF:"Paracel Islands",PG:"Spratly Islands",PJ:"Etorofu, Habomai, Kunashiri, and Shikotan Islands",PK:"Pakistan",PL:"Poland",PM:"Panama",PO:"Portugal",PP:"Papua New Guinea",PS:"Palau",PU:"Guinea-Bissau",QA:"Qatar",RE:"Réunion",RI:"Serbia",RM:"Marshall Islands",RN:"Saint Martin",RO:"Romania",RP:"Philippines",RQ:"Puerto Rico",RS:"Russia",RW:"Rwanda",SA:"Saudi Arabia",SB:"Saint Pierre and Miquelon",SC:"Saint Kitts and Nevis",SE:"Seychelles",SF:"South Africa",SG:"Senegal",SH:"Saint Helena, Ascension, and Tristan da Cunha",SI:"Slovenia",SL:"Sierra Leone",SM:"San Marino",SN:"Singapore",SO:"Somalia",SP:"Spain",ST:"Saint Lucia",SU:"Sudan",SV:"Svalbard",SW:"Sweden",SX:"South Georgia and South Sandwich Islands",SY:"Syria",SZ:"Switzerland",TB:"Saint Barthelemy",TD:"Trinidad and Tobago",TE:"French Southern and Antarctic Lands Tromelin Island",TH:"Thailand",TI:"Tajikistan",TK:"Turks and Caicos Islands",TL:"Tokelau",TN:"Tonga",TO:"Togo",TP:"Sao Tome and Principe",TS:"Tunisia",TT:"Timor-Leste",TU:"Turkey",TV:"Tuvalu",TW:"Taiwan",TX:"Turkmenistan",TZ:"Tanzania",UC:"Curaçao",UG:"Uganda",UK:"United Kingdom",UP:"Ukraine",US:"United States",UV:"Burkina Faso",UY:"Uruguay",UZ:"Uzbekistan",VC:"Saint Vincent and the Grenadines",VE:"Venezuela",VI:"British Virgin Islands",VN:"Vietnam",VQ:"United States Virgin Islands",VT:"Vatican City",WA:"Namibia",WE:"West Bank",WF:"Wallis and Futuna",WI:" Western Sahara",WQ:"Wake Island",WS:"Samoa",WZ:"Swaziland",YM:"Yemen",ZA:"Zambia",ZI:"Zimbabwe"};return t[e]?t[e]:e}function determineChartContent(e){var t=$(selectedTab).find("#query-count").val();return t.indexOf("primarysource.reportercountry")>=0?"primarysource.reportercountry":t.indexOf("primarysource.qualification")>=0?"primarysource.qualification":t.indexOf("serious")>=0?"serious":t.indexOf("patient.patientsex")>=0?"patient.patientsex":t.indexOf("classification")>=0?"classification":t.indexOf("voluntary_mandated")>=0?"voluntary_mandated":t.indexOf("effective_time")>=0?"effective_time":t.indexOf("date")>=0?"date":t.indexOf("_country")>=0?"country_code":""!==t&&e.length>=1?"count":void 0}function updateResultCount(e){$(selectedTab).find("#result-count").text(numberToCommaSeparated(e)+" records match these search parameters")}function updateCoverageChart(e,t){e-=t,c3.generate({bindto:selectedCoverageChart,data:{columns:[["Records that don't match this search",e],["Records that match this search",t]],type:"donut",groups:[["Records that don't match this search","Records that match this search"]]},color:{pattern:["#d2d2d2","#888"]},size:{height:65,width:65},margin:0,legend:{show:!1},label:{show:!1}})}function drawChartWithData(e){function t(e,t){c3.generate({bindto:selectedChart,data:{columns:[e],type:"bar"},color:{pattern:["#00539b"]},bar:{width:{ratio:.35}},axis:{rotated:!0,x:{type:"categorized",categories:t},y:{show:!1,ticks:{culling:{max:1}}}},labels:!0,size:{height:u},legend:{show:!1}})}function a(e){c3.generate({bindto:selectedChart,data:{columns:e,type:"donut"},color:{pattern:["#8bc3e0","#74a9d6","#5e8dcc","#4a6fc2","#3751b8","#8be095","#74d674"]},labels:!0,size:{height:u},legend:{show:!0,position:"right"}})}function n(e,t){c3.generate({bindto:selectedChart,data:{x:"Date",x_format:"%Y%m",columns:[t,e]},point:{show:!1},color:{pattern:["#00539b"]},axis:{x:{type:"timeseries",tick:{format:"%Y-%m",culling:{max:6}}},y:{tick:{culling:{max:4}}}},legend:{show:!1},size:{height:u}})}function r(e,t,a){$.each(e,function(e,n){var r=[];$.each(n,function(e,a){r.push(t(e,a))}),"bar"===a?(o.push(r[0]),s.push(r[1])):s.push(r)})}function i(e,t,a){var n=d3.nest().key(function(e){return e.time.slice(0,6)}).rollup(function(e){return d3.sum(e,function(e){return e.count})}).entries(e);n.map(function(e){a.push(e.key),t.push(e.values)})}var o=[],s=[],d=determineChartContent(e),u=300;if("count"===d){s.push("# of matching records"),e=e.slice(0,10);var c=function(e,t){return"term"==e&&(""==t&&(t="null/no value"),t=t.toLowerCase()),t};r(e,c,"bar"),t(s,o)}else if("date"===d)s.push("Reports"),o.push("Date"),i(e,s,o),n(s,o);else if("effective_time"===d)s.push("Submissions"),o.push("Date"),i(e,s,o),n(s,o);else if("primarysource.qualification"===d){e=e.slice(0,5);var c=function(e,t){return"term"==e&&("1"==t?t="Physician":"2"==t?t="Pharmacist":"3"==t?t="Other health professional":"4"==t?t="Lawyer":"5"==t&&(t="Consumer or non-health professional")),t};r(e,c,"donut"),a(s)}else if("primarysource.reportercountry"===d){s.push("Reporter country"),e=e.slice(0,10);var c=function(e,t){return"term"==e&&(t=stringToTitleCase(t)),t};r(e,c,"bar"),t(s,o)}else if("serious"===d){e=e.slice(0,2);var c=function(e,t){return"term"==e&&("1"==t?t="Death, life threatening condition, hospitalization, disability, congenital anomali, or other serious condition":"2"==t&&(t="Other")),t};r(e,c,"donut"),a(s)}else if("patient.patientsex"===d){e=e.slice(0,3);var c=function(e,t){return"term"==e&&("1"==t?t="Male":"2"==t?t="Female":"0"==t&&(t="Other")),t};r(e,c,"donut"),a(s)}else if("classification"===d){e=e.slice(0,3);var c=function(e,t){return t};r(e,c,"donut"),a(s)}else if("voluntary_mandated"===d){e=e.slice(0,2);var c=function(e,t){return t};r(e,c,"donut"),a(s)}else if("country_code"===d){s.push("Reports"),e=e.slice(0,10);var c=function(e,t){return"term"==e&&(t=replaceCountryCode(t)),t};r(e,c,"bar"),t(s,o)}else console.log("Not countable")}function runQueries(e,t){$.getJSON(t).success(function(e){drawChartWithData(e.results)}).fail(function(){console.log("fails"),$(selectedTab).find("#query-endpoint").popover({trigger:"manual",container:"body",placement:"top",content:"Oh no! The API query failed. It's probably due to a syntax error (double-check the query and spelling), or because the API couldn't be reached."}).on("shown.bs.popover",function(){setTimeout(function(){$(selectedTab).find("#query-endpoint").popover("hide")},7e3)}),$(selectedTab).find("#query-endpoint").popover("show")}),$.getJSON(e,function(e){var t=e.meta.results.total;updateCoverageChart(maxNumberOfRecords,t),updateResultCount(t)})}function constructAndExecuteQuery(){var e=endpoint,t=$(selectedTab).find("#query-search").val(),a=$(selectedTab).find("#query-count").val(),n=e;""!=t&&(n+="search="+t),""==t&&(n=e+"search="+countTerm+"&limit=1"),""!=t&&(e+="search="+t),""!=a&&(e+="&count="+a),runQueries(n,e),$(selectedTab).find("#query-endpoint").text(e)}var selectedTab=$(".tab-content > .tab-pane.active"),selectedChart=$(selectedTab).find("#chart")[0],selectedCoverageChart=$(selectedTab).find("#chart-coverage")[0],maxNumberOfRecords;$(document).ready(function(){constructAndExecuteQuery(),$.getJSON(endpoint+"search="+countTerm,function(e){maxNumberOfRecords=e.meta.results.total}),$(selectedTab).find("#query-button").on("click",function(){constructAndExecuteQuery()}),$('a[data-toggle="pill"]').on("shown.bs.tab",function(e){selectedTab=$(".tab-content > .tab-pane.active"),selectedChart=$(selectedTab).find("#chart")[0],selectedCoverageChart=$(selectedTab).find("#chart-coverage")[0],$(e.relatedTarget[0]).find("#query-button").off("click"),$(selectedTab).find("#query-button").on("click",function(){constructAndExecuteQuery()});var t=$(selectedTab).find("input[name=api-query-options-search]:radio")[0];$(t).trigger("click"),constructAndExecuteQuery(),$("textarea").autosize().show().trigger("autosize.resize")})}),$(".tab-pane").find("input[name=api-query-options-search]:radio").change(function(){var e=$(".tab-pane").find("#query-search"),t=$(this).val();e.val(t),$(selectedTab).find("#query-button").trigger("click"),$("textarea").autosize().trigger("autosize.resize")}),$(".query-textarea").keypress(function(e){var t=e.keyCode?e.keyCode:e.which,a=$(this).parents(".tab-pane").find("#query-button");$(this).parents(".api-query-options").find("input").prop("checked",!1),32===t?e.preventDefault():13===t&&(e.preventDefault(),$(a).trigger("click"))}),Modernizr.svg||($("#api-demo").hide(),$("#api-demo-no-svg").show());